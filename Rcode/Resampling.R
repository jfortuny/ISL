## Cross Validation

# Prepare the environment
library (ISLR)
set.seed(1)
train <- sample(392, 196)

# Use the Auto dataset to fit a linear model
# Fix the NA values in horsepower first
Auto[is.na(Auto$horsepower),c("horsepower")] <- mean(Auto$horsepower, na.rm=T)
lm.fit <- lm(mpg~horsepower, data=Auto, subset=train)
mean((Auto$mpg - predict(lm.fit, Auto))[-train]^2)
# And to fit a polynomial model
lm.fit2 <- lm(mpg[train]~poly(horsepower[train],2),data=Auto)
mean((Auto$mpg[train] - predict(lm.fit2,Auto))[-train]^2)

# Leave one out Cross Validation (LOOCV)
library(boot)
glm.fit <- glm(mpg~horsepower, data=Auto)
#cv.err <- cv.glm(Auto, glm.fit)
#cv.err$delta
# fit through the fifth degree polynomial
cv.error <- rep(0,5)
for (i in 1:5) {
  glm.fit <- glm(mpg~poly(horsepower, i), data=Auto)
  cv.error[i] = cv.glm(Auto, glm.fit)$delta[1]
}
cv.error
plot(cv.error)
lines(cv.error)

# k-fold CV
set.seed(17)
cv.error.10 = rep(0,10)
for (i in 1:10) {
  glm.fit <- glm(mpg~poly(horsepower, i), data=Auto)
  cv.error.10[i] = cv.glm(Auto, glm.fit, K=10)$delta[1]
}
cv.error.10
plot(cv.error.10)
lines(cv.error.10)

# The Bootstrap
# This is for the example of the investment selection in section 5.2
# First we create the function that estimates the value of alpha
alpha.fn <- function (data, index) {
  X <- data$X[index]
  Y <- data$Y[index]
  return((var(Y)-cov(X,Y))/(var(X)+var(Y)-2*cov(X,Y)))
}
set.seed(1)
alpha.fn(Portfolio, sample(100, 100, replace=T))
boot(Portfolio, alpha.fn, R=1000)

# Now to estimate the accuracy of a linear regression model
boot.fn <- function (data, index) {
  return(coef(lm(mpg~horsepower, data=data, subset=index)))
}
set.seed(1)
boot.fn(Auto, sample(392,392,replace=TRUE))
# now run the bootstrap
boot(Auto, boot.fn, 1000)
# compare against the theoretical values
summary(lm(mpg∼horsepower,data=Auto))$coef

# Let's now fit a quadratic model and use the bootstrap
boot.fn <- function (data, index) {
  coefficients(lm(mpg∼horsepower+I(horsepower^2),data=data,subset=index))
}
set.seed(1)
boot(Auto, boot.fn, 1000)
# and compare against the lm calculated SE values
summary(lm(mpg∼horsepower+I(horsepower^2),data=Auto))$coef
